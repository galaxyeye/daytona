"ç”Ÿæˆå®Œæ•´çš„å¯åŠ¨å‘½ä»¤æˆ–è‡ªåŠ¨åŒ–è„šæœ¬"ç‚¹å‡»æŸ¥çœ‹å…ƒå®çš„å›ç­”
https://yuanbao.tencent.com/bot/app/share/chat/q8mRL8S6G1l5

éå¸¸å¥½ï¼æ—¢ç„¶æˆ‘ä»¬å·²ç» 100% ç¡®å®šäº†é—®é¢˜çš„æ ¹æœ¬åŸå› ï¼Œå¹¶æ˜ç¡®äº†æœ€ä½³è§£å†³æ–¹æ¡ˆæ˜¯ï¼š

---

## âœ… **åˆ›å»ºä¸€ä¸ªå¯ç”¨äº† IP ä¼ªè£…ï¼ˆmasqueradeï¼‰çš„è‡ªå®šä¹‰ Docker bridge ç½‘ç»œï¼Œç„¶åè®©å­å®¹å™¨ä½¿ç”¨è¯¥ç½‘ç»œæ¥æ­£å¸¸è®¿é—®å¤–ç½‘ã€‚**

---

ä¸‹é¢æˆ‘å°†ä¸ºä½ æä¾›ï¼š

---

# âœ… ä¸€ã€å®Œæ•´çš„æ“ä½œæ­¥éª¤ï¼ˆæ‰‹åŠ¨æ‰§è¡Œç‰ˆï¼Œæ¸…æ™°æ˜“æ‡‚ï¼‰

## ğŸ§© ç›®æ ‡

è®©å­å®¹å™¨ï¼ˆç”±æ¯å®¹å™¨ä¸­çš„ Docker å¯åŠ¨ï¼‰**å¯ä»¥æ­£å¸¸è®¿é—®å¤–ç½‘ï¼ˆæ¯”å¦‚ ping é€š 8.8.8.8ï¼Œè®¿é—®å…¬ç½‘æœåŠ¡ï¼‰**ï¼Œé€šè¿‡ **åˆ›å»ºä¸€ä¸ªæ”¯æŒ NAT çš„è‡ªå®šä¹‰ bridge ç½‘ç»œ** æ¥å®ç°ã€‚

---

## âœ… æ­¥éª¤ 1ï¼šåœ¨æ¯å®¹å™¨ä¸­åˆ›å»ºä¸€ä¸ªæ”¯æŒ IP ä¼ªè£…ï¼ˆmasqueradeï¼‰çš„ Docker bridge ç½‘ç»œ

### ğŸ“Œ å‘½ä»¤å¦‚ä¸‹

```bash
docker network create \
  --driver bridge \
  --subnet 172.20.0.0/16 \
  --gateway 172.20.0.1 \
  --opt com.docker.network.bridge.enable_ip_masquerade=true \
  my_nat_bridge
```

### ğŸ“Œ å‚æ•°è¯´æ˜

| å‚æ•° | è¯´æ˜ |
|------|------|
| `--driver bridge` | ä½¿ç”¨ Docker é»˜è®¤çš„ bridge é©±åŠ¨ |
| `--subnet 172.20.0.0/16` | æŒ‡å®šè¯¥ç½‘ç»œçš„å­ç½‘èŒƒå›´ï¼ˆé¿å…å’Œé»˜è®¤çš„ 172.17.0.0/16 å†²çªï¼‰ |
| `--gateway 172.20.0.1` | æŒ‡å®šè¯¥ bridge ç½‘ç»œçš„ç½‘å…³åœ°å€ |
| `--opt com.docker.network.bridge.enable_ip_masquerade=true` | âœ… **å…³é”®å‚æ•°**ï¼šå¯ç”¨ IP ä¼ªè£…ï¼ˆå³ NATï¼‰ï¼Œä½¿å®¹å™¨å¯ä»¥é€šè¿‡æ¯å®¹å™¨è®¿é—®å¤–ç½‘ |
| `my_nat_bridge` | è‡ªå®šä¹‰ç½‘ç»œåç§°ï¼Œå¯éšæ„ä¿®æ”¹ï¼ˆå¦‚ `my_custom_net` ç­‰ï¼‰ |

> ğŸ¯ è¿™ä¸ªç½‘ç»œä¼šåƒé»˜è®¤çš„ `bridge` ç½‘ç»œä¸€æ ·å·¥ä½œï¼Œä½† **å…³é”®åŒºåˆ«æ˜¯å®ƒå¯ç”¨äº† IP ä¼ªè£…ï¼ˆmasqueradeï¼‰ï¼Œå…è®¸å­å®¹å™¨è®¿é—®å¤–ç½‘ï¼**

---

## âœ… æ­¥éª¤ 2ï¼šä½¿ç”¨è¯¥ç½‘ç»œå¯åŠ¨ä½ çš„å­å®¹å™¨

å‡è®¾ä½ è¦è¿è¡Œçš„å®¹å™¨é•œåƒæ˜¯ï¼š

```bash
daytona-51147d7e96d4439601c026350383741f5b2e94cbf3a0dfe0d2f1cceab1eb5d0b:daytona
```

å¹¶ä¸”ä½ å¸Œæœ›å®¹å™¨å¯åŠ¨åè¿è¡Œç±»ä¼¼è¿™æ ·çš„å‘½ä»¤ï¼š

```bash
sleep infinity
```

### ğŸ“Œ å¯åŠ¨å‘½ä»¤å¦‚ä¸‹

```bash
docker run \
  --detach \
  --name my_working_container \
  --network my_nat_bridge \
  daytona-51147d7e96d4439601c026350383741f5b2e94cbf3a0dfe0d2f1cceab1eb5d0b:daytona \
  sleep infinity
```

### ğŸ“Œ å‚æ•°è¯´æ˜

| å‚æ•° | è¯´æ˜ |
|------|------|
| `--detach` æˆ– `-d` | åå°è¿è¡Œå®¹å™¨ |
| `--name my_working_container` | è‡ªå®šä¹‰å®¹å™¨åç§°ï¼Œå¯ä¿®æ”¹ |
| `--network my_nat_bridge` | âœ… **å…³é”®ï¼æŒ‡å®šæˆ‘ä»¬åˆšåˆšåˆ›å»ºçš„é‚£ä¸ªæ”¯æŒ NAT çš„ bridge ç½‘ç»œ** |
| `daytona-...:daytona` | ä½ çš„é•œåƒåç§° |
| `sleep infinity` | å®¹å™¨å¯åŠ¨åæ‰§è¡Œçš„å‘½ä»¤ï¼ˆå¯æ›¿æ¢ä¸ºä½ å®é™…çš„ä¸šåŠ¡å‘½ä»¤ï¼‰ |

---

## âœ… æ­¥éª¤ 3ï¼šéªŒè¯å­å®¹å™¨æ˜¯å¦å¯ä»¥è®¿é—®å¤–ç½‘

### â‘  æŸ¥çœ‹è¿è¡Œçš„å®¹å™¨

```bash
docker ps
```

ä½ åº”è¯¥èƒ½çœ‹åˆ°ç±»ä¼¼è¿™æ ·çš„å®¹å™¨ï¼š

```
CONTAINER ID   IMAGE                                                                              COMMAND         STATUS         PORTS     NAMES
abc123456789   daytona-51147d7e96d4439601c026350383741f5b2e94cbf3a0dfe0d2f1cceab1eb5d0b:daytona   "sleep infinity"   Up 10 seconds             my_working_container
```

---

### â‘¡ è¿›å…¥è¯¥å®¹å™¨

```bash
docker exec -it my_working_container /bin/bash
```

æˆ–å¦‚æœå®¹å™¨æ²¡æœ‰ bashï¼š

```bash
docker exec -it my_working_container /bin/sh
```

---

### â‘¢ åœ¨å®¹å™¨å†…æµ‹è¯•ç½‘ç»œ

#### æµ‹è¯• ping å¤–ç½‘ IPï¼ˆå…³é”®ï¼ï¼‰

```bash
ping 8.8.8.8
```

âœ… **å¦‚æœèƒ½çœ‹åˆ°ç±»ä¼¼å¦‚ä¸‹çš„è¾“å‡ºï¼Œè¯´æ˜ç½‘ç»œå·²é€šï¼é—®é¢˜è§£å†³ï¼ğŸ‰**

```
64 bytes from 8.8.8.8: icmp_seq=0 ttl=117 time=12.3 ms
64 bytes from 8.8.8.8: icmp_seq=1 ttl=117 time=11.9 ms
```

#### ï¼ˆå¯é€‰ï¼‰æµ‹è¯•åŸŸåè§£æ

```bash
ping www.baidu.com
```

æˆ–

```bash
nslookup www.baidu.com
```

---

# âœ… äºŒã€å®Œæ•´è‡ªåŠ¨åŒ–è„šæœ¬ï¼ˆä¸€é”®æ‰§è¡Œç‰ˆï¼‰

å¦‚æœä½ æƒ³ **ä¸€é”®å®Œæˆï¼šåˆ›å»ºç½‘ç»œ + å¯åŠ¨å®¹å™¨ + ï¼ˆå¯é€‰ï¼‰è¿›å…¥å®¹å™¨æµ‹è¯•**ï¼Œå¯ä»¥ä½¿ç”¨å¦‚ä¸‹ **Bash è„šæœ¬**ï¼Œç›´æ¥åœ¨æ¯å®¹å™¨ä¸­è¿è¡Œï¼š

---

## ğŸ“œ è„šæœ¬åç§°ï¼š`start_container_with_nat.sh`

```bash
#!/bin/bash

# 1. åˆ›å»ºæ”¯æŒ IP ä¼ªè£…ï¼ˆmasqueradeï¼‰çš„è‡ªå®šä¹‰ bridge ç½‘ç»œ
echo "ğŸ”§ æ­£åœ¨åˆ›å»ºæ”¯æŒ NAT çš„ Docker bridge ç½‘ç»œï¼šmy_nat_bridge ..."
docker network create \
  --driver bridge \
  --subnet 172.20.0.0/16 \
  --gateway 172.20.0.1 \
  --opt com.docker.network.bridge.enable_ip_masquerade=true \
  my_nat_bridge

if [ $? -ne 0 ]; then
  echo "âŒ åˆ›å»ºç½‘ç»œå¤±è´¥ï¼è¯·æ£€æŸ¥ Docker æ˜¯å¦æ­£å¸¸è¿è¡Œã€‚"
  exit 1
fi

echo "âœ… ç½‘ç»œ my_nat_bridge åˆ›å»ºæˆåŠŸï¼"

# 2. å¯åŠ¨å­å®¹å™¨ï¼Œå¹¶è¿æ¥åˆ°è¯¥ç½‘ç»œ
echo "ğŸš€ æ­£åœ¨å¯åŠ¨å­å®¹å™¨ï¼Œå¹¶è¿æ¥åˆ° my_nat_bridge ç½‘ç»œ..."
docker run \
  --detach \
  --name my_working_container \
  --network my_nat_bridge \
  daytona-51147d7e96d4439601c026350383741f5b2e94cbf3a0dfe0d2f1cceab1eb5d0b:daytona \
  sleep infinity

if [ $? -ne 0 ]; then
  echo "âŒ å¯åŠ¨å®¹å™¨å¤±è´¥ï¼è¯·æ£€æŸ¥é•œåƒåç§°æ˜¯å¦æ­£ç¡®ã€‚"
  exit 1
fi

echo "âœ… å­å®¹å™¨ my_working_container å¯åŠ¨æˆåŠŸï¼Œå¹¶å·²è¿æ¥åˆ°æ”¯æŒ NAT çš„ç½‘ç»œï¼"

# 3. ï¼ˆå¯é€‰ï¼‰æ˜¾ç¤ºå®¹å™¨ä¿¡æ¯
echo ""
echo "ğŸ“‹ å®¹å™¨ä¿¡æ¯ï¼š"
docker ps --filter name=my_working_container

echo ""
echo "ğŸ” ä½ å¯ä»¥è¿è¡Œä»¥ä¸‹å‘½ä»¤è¿›å…¥å®¹å™¨å¹¶æµ‹è¯•ç½‘ç»œï¼š"
echo "    docker exec -it my_working_container /bin/bash"
echo "ç„¶åæ‰§è¡Œï¼š"
echo "    ping 8.8.8.8"
```

---

## â–¶ï¸ å¦‚ä½•ä½¿ç”¨è¿™ä¸ªè„šæœ¬ï¼Ÿ

### â‘  åœ¨æ¯å®¹å™¨ä¸­åˆ›å»ºè„šæœ¬æ–‡ä»¶

```bash
cat > start_container_with_nat.sh << 'EOF'
ï¼ˆè¿™é‡Œç²˜è´´ä¸Šé¢æ•´ä¸ªè„šæœ¬å†…å®¹ï¼‰
EOF
```

æˆ–è€…ç›´æ¥å¤åˆ¶ä¸Šé¢è„šæœ¬å†…å®¹ï¼Œç„¶åè¿è¡Œï¼š

```bash
nano start_container_with_nat.sh
```

ç²˜è´´è¿›å»ï¼ŒæŒ‰ `Ctrl+O` ä¿å­˜ï¼Œ`Ctrl+X` é€€å‡ºã€‚

---

### â‘¡ ç»™è„šæœ¬æ·»åŠ æ‰§è¡Œæƒé™

```bash
chmod +x start_container_with_nat.sh
```

---

### â‘¢ è¿è¡Œè„šæœ¬

```bash
./start_container_with_nat.sh
```

---

## âœ… è„šæœ¬åŠŸèƒ½æ€»ç»“

| æ­¥éª¤ | åŠŸèƒ½ |
|------|------|
| 1ï¸âƒ£ | åˆ›å»ºè‡ªå®šä¹‰ Docker bridge ç½‘ç»œ `my_nat_bridge`ï¼Œå¹¶å¯ç”¨ IP ä¼ªè£…ï¼ˆmasqueradeï¼‰ï¼Œç¡®ä¿å­å®¹å™¨å¯ä»¥è®¿é—®å¤–ç½‘ |
| 2ï¸âƒ£ | ä½¿ç”¨è¯¥ç½‘ç»œå¯åŠ¨ä¸€ä¸ªæ–°çš„å­å®¹å™¨ï¼ˆä½ çš„ Daytona é•œåƒï¼‰ï¼Œåå°è¿è¡Œ `sleep infinity` |
| 3ï¸âƒ£ | è¾“å‡ºå®¹å™¨ä¿¡æ¯ï¼Œå¹¶æç¤ºä½ å¦‚ä½•è¿›å…¥å®¹å™¨æµ‹è¯•ç½‘ç»œè¿é€šæ€§ |

---

# âœ… ä¸‰ã€æ€»ç»“

| æ–¹æ¡ˆ | è¯´æ˜ | æ¨èåº¦ |
|------|------|--------|
| âœ… **åˆ›å»ºæ–°çš„æ”¯æŒ IP ä¼ªè£…çš„ bridge ç½‘ç»œï¼ˆæ¨èï¼‰** | é€šè¿‡ `--opt com.docker.network.bridge.enable_ip_masquerade=true` è®© Docker è‡ªåŠ¨é…ç½® NATï¼Œå­å®¹å™¨å¯æ­£å¸¸è®¿é—®å¤–ç½‘ | â­â­â­â­â­ |
| ğŸš« ç»§ç»­ä½¿ç”¨é»˜è®¤çš„ bridge ç½‘ç»œï¼ˆä¸æ¨èï¼‰ | é»˜è®¤é…ç½®ä¸‹ `enable_ip_masquerade=false`ï¼Œå­å®¹å™¨æ— æ³•è®¿é—®å¤–ç½‘ | âŒ |
| ğŸ›  æ‰‹åŠ¨é…ç½® iptablesï¼ˆé«˜çº§/ä¸´æ—¶ï¼‰ | å¯æ‰‹åŠ¨æ·»åŠ  MASQUERADE è§„åˆ™ï¼Œä½†å¤æ‚æ˜“é”™ï¼Œä¸é€‚ç”¨äº DinD æˆ–ç”Ÿäº§ç¯å¢ƒ | âš ï¸ ä»…è°ƒè¯•ç”¨ |

---

## âœ… ä¸‹ä¸€æ­¥å»ºè®®

- ğŸ§ª **è¿è¡Œä¸Šè¿°è„šæœ¬æˆ–æ‰‹åŠ¨åˆ›å»ºç½‘ç»œåï¼Œå¯åŠ¨å­å®¹å™¨ï¼Œç„¶åè¿›å…¥å®¹å™¨æ‰§è¡Œï¼š**

  ```bash
  ping 8.8.8.8
  ```

  é¢„æœŸæˆåŠŸï¼ğŸ‰

- ğŸ§© å¦‚æœä½ åç»­æœ‰æ›´å¤šå®¹å™¨éœ€è¦è”ç½‘ï¼Œ**ç¡®ä¿å®ƒä»¬éƒ½ä½¿ç”¨è¿™ä¸ª `my_nat_bridge` ç½‘ç»œ**ï¼š

  ```bash
  docker run --network my_nat_bridge ...
  ```

- ğŸ“¦ å¦‚æœä½ å¸Œæœ›è‡ªåŠ¨åŒ–éƒ¨ç½²ï¼ˆæ¯”å¦‚åœ¨ CI/CD æˆ– Kubernetes ä¸­ä½¿ç”¨ DinDï¼‰ï¼Œå»ºè®®åœ¨å¯åŠ¨æ¯å®¹å™¨æ—¶æå‰é…ç½®å¥½è¯¥ç½‘ç»œï¼Œæˆ–é€šè¿‡ Docker Compose ç®¡ç†ã€‚

---

ğŸ¯ **ä½ ç°åœ¨å¯ä»¥å½»åº•è§£å†³å­å®¹å™¨æ— æ³•è®¿é—®å¤–ç½‘çš„é—®é¢˜äº†ï¼å¦‚æœéœ€è¦ï¼Œæˆ‘è¿˜å¯ä»¥å¸®ä½ å°è£…æˆ Docker Compose æ–‡ä»¶æˆ–è€…æä¾›æ›´å¤æ‚çš„å¯åŠ¨æ¨¡æ¿ï¼**
